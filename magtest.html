<html>
    <body>
        <div id="container"></div>
        <script type="text/javascript">
        var cvs = document.createElement("canvas");
        cvs.width = 500;
        cvs.height = 500;
        document.getElementById('container').appendChild(cvs);
         
        var ctx = cvs.getContext("2d");
         
         
        //Dustを生成して、ランダムな位置に配置
        var dusts = [];
        for (var i = 0; i < 50; i++) {
           var dust = new Dust();
           dust.x = Math.random() * 500;
           dust.y = Math.random() * 500;
         
           dusts.push(dust);
        }
         
         
        //Magnetを生成して、中央に配置
        var magnet = new Magnet(dusts);
        magnet.x = magnet.y = 50;
         
         
        function Dust() {
           var me = this;
         
           this.x = 0;
           this.y = 0;
           this.radius = 5;
         
           this.draw = function(ctx) {
               ctx.beginPath();
               ctx.fillStyle = "black";
               ctx.arc(me.x, me.y, me.radius, 0, 2 * Math.PI, true);
               ctx.fill();
               ctx.stroke();
           };
        }
         
        function Magnet(dusts) {
           var me = this;
         
           this.x = 0;
           this.y = 0;
           this.size = 30;
         
           var timer;
           var isDrag = false;
         
           this.draw = function(ctx) {
               ctx.strokeStyle = "#000";
               ctx.fillStyle = "#aaa";
               ctx.fillRect(me.x, me.y, me.size, me.size);
               ctx.strokeRect(me.x, me.y, me.size, me.size);
           };
         
           window.addEventListener("mousedown", function(e) {
               if (me.x < e.layerX && e.layerX < me.x + me.size && me.y < e.layerY && e.layerY < me.y + me.size) {
                   isDrag = true;
         
                   timer = setInterval(function() {
                       for (var i = 0; i < dusts.length; i++) {
                           computeAttractiveForce(me, dusts[i]);
                       }
                   }, 50);
               }
           });
         
           window.addEventListener("mousemove", function(e) {
               if (isDrag) {
                   me.x = e.layerX;
                   me.y = e.layerY;
               }
           });
         
           window.addEventListener("mouseup", function(e) {
               isDrag = false;
               clearInterval(timer);
           });
        }
         
         
        //MagnetによるDustの引力を計算する
        function computeAttractiveForce(magnet, dust) {
           var v = 5; //移動量
           var dx = (magnet.x - dust.x);
           var dy = (magnet.y - dust.y);
           var distance = Math.sqrt(dx * dx + dy * dy) / 10000;
           dust.x += dx * distance;
           dust.y += dy * distance;
        }
         
         
        //Dust同士の斥力分だけ移動させる
        function computeRepulsiveForce(dusts) {         
           for (var i = 0; i < dusts.length; i++) {
               var movementX = 0;
               var movementY = 0;
               for (var j = 0; j < dusts.length; j++) {
                   if (i == j) continue;
                   var dx = dusts[i].x - dusts[j].x;
                   var dy = dusts[i].y - dusts[j].y;
                   var distance = Math.sqrt(dx * dx + dy * dy)/2;
                   if (distance > dusts[i].radius + dusts[j].radius) continue;
         
                   movementX += dx / distance;
                   movementY += dy / distance; 
               }
               dusts[i].x += movementX;
               dusts[i].y += movementY;
           }
        }
         
         
        function render() {
           ctx.clearRect(0, 0, 500, 500);
         
           computeRepulsiveForce(dusts);
         
           for (var i = 0; i < dusts.length; i++) {
               dusts[i].draw(ctx);
           }
         
           magnet.draw(ctx);
        }
         
        setInterval(render, 30);
        </script>
    </body>
</html>