<html>
    <head>
        <meta charset="utf-8"/>
    </head>
    <script src="arrow.js"></script>
    <body>
        <div id="add_node">
            ノード名<input type="text" id="node_name" value=""></input>
            <input type="button" value="追加" onclick="addNode(document.getElementById('node_name').value);"></input>
        </div>

        <div id="add_link">
            リンク名<input type="text" id="link_name" value=""></input>
            from <input type="text" id="from_node" value=""></input>
            to <input type="text" id="to_node" value=""></input>
            <input type="button" value="追加" onclick="addLink(document.getElementById('link_name').value, document.getElementById('from_node').value, document.getElementById('to_node').value);"></input>
        </div>

        <div id="container"></div>
        <script type="text/javascript">
        var cvs = document.createElement("canvas");
        cvs.width = 500;
        cvs.height = 500;
        document.getElementById('container').appendChild(cvs);
  
        var ctx = cvs.getContext("2d");
        
        // Node1 and Node2
        var nodes = {};
        var links = {};
        var node1 = new Node();
        node1.x = 100;
        node1.y = 100;
        node1.name = "Node1";
        nodes[node1.name] = node1;
        links[node1.name] = {};

        var node2 = new Node();
        node2.x = 300;
        node2.y = 100;
        node2.name = "Node2";
        nodes[node2.name] = node2;
        links[node2.name] = {};

        // link from node1 to node2
        var link1 = new Link(node1, node2);
        link1.set_label("link1");
        links[node1.name][node2.name] = link1;

        // link from node2 to node1
        var link2 = new Link(node2, node1);
        link2.set_label("link2");
        links[node2.name][node1.name] = link2;

        function addNode(node_name) {
            var node = new Node();
            node.name = node_name;
            node.x = 500*Math.random();
            node.y = 500*Math.random();
            nodes[node_name] = node;
            links[node_name] = {};
        }

        function addLink(link_name, from_node_name, to_node_name) {
            var link = new Link(nodes[from_node_name], nodes[to_node_name]);
            link.set_label(link_name);
            links[from_node_name][to_node_name] = link;
        }

        function Link(from_node, to_node) {
            this.from_node = from_node;
            this.to_node = to_node;
            this.theta = Math.atan2((this.to_node.y - this.from_node.y), (this.to_node.x - this.from_node.x));
            this.label = "";
            this.arrow = new arrow(
                        this.from_node.x + this.from_node.r * Math.cos(this.theta), 
                        this.from_node.y + this.from_node.r * Math.sin(this.theta), 
                        this.to_node.x - this.to_node.r * Math.cos(this.theta), 
                        this.to_node.y - this.to_node.r * Math.sin(this.theta), 
                        [0, 5, -20, 5, -20, 15]
            );

            this.set_label = function(label) {
                this.label = label;
                this.arrow.label = label;
            };

            this.draw = function(ctx) {
                this.theta = Math.atan2((this.to_node.y - this.from_node.y), (this.to_node.x - this.from_node.x));
                this.arrow.update(
                        this.from_node.x + this.from_node.r * Math.cos(this.theta), 
                        this.from_node.y + this.from_node.r * Math.sin(this.theta), 
                        this.to_node.x - this.to_node.r * Math.cos(this.theta), 
                        this.to_node.y - this.to_node.r * Math.sin(this.theta), 
                        [0, 5, -20, 5, -20, 15]
                );
                this.arrow.draw(ctx);
            }
        }

        function Node() {
            var me = this;
         
            this.x = 0;
            this.y = 0;
            this.r = 50;
            this.isDragged = false;
            this.name = "None";
            this.draw = function(ctx) {

                ctx.fillStyle = "gray";
                ctx.strokeStyle = "black";
                ctx.beginPath();
                ctx.arc(me.x, me.y, me.r, 0, 2 * Math.PI, true);
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
                ctx.beginPath();
                ctx.fillStyle = "red";
                ctx.textBaseline = "middle";
                ctx.fillText(this.name, this.x-ctx.measureText(this.name).width/2, this.y);
                ctx.fill();
            };

            window.addEventListener("mousedown", function(e) {
                var dx = me.x - e.layerX;
                var dy = me.y - e.layerY;
                me.isDragged = Math.sqrt(dx * dx + dy * dy) < me.r;
            });
         
            window.addEventListener("mousemove", function(e) {
                if (me.isDragged) {
                    me.x = e.layerX;
                    me.y = e.layerY;
                }
            });
         
            window.addEventListener("mouseup", function(e) {
                me.isDragged = false;
            });
        }

        function render() {
            ctx.clearRect(0, 0, 500, 500);
            ctx.strokeStyle = "gray";

            // Draw link1
            ctx.save();
            ctx.translate(15*Math.cos(link1.theta + Math.PI/2), 15*Math.sin(link1.theta + Math.PI/2));
            link1.draw(ctx);
            ctx.restore();

            // Draw link2
            ctx.save();
            ctx.translate(15*Math.cos(link2.theta + Math.PI/2), 15*Math.sin(link2.theta + Math.PI/2));
            link2.draw(ctx);
            ctx.restore();

            for (var n1 in links) {
                for (var n2 in links[n1]) {
                    if (links[n1][n2].label != "link1" && links[n1][n2].label != "link2") {
                        links[n1][n2].draw(ctx);
                    }
                }
            }

            // Draw nodes
            for (var name in nodes) {
                nodes[name].draw(ctx);
            }
        }
         
        setInterval(render, 30);
    </script>
    </body>
</html>